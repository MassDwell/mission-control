<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mission Control v2 - Agent Operations Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'mission-bg': '#0f172a',
                        'mission-card': '#1e293b',
                        'mission-accent': '#3b82f6',
                        'mission-success': '#22c55e',
                        'mission-warning': '#f59e0b',
                        'mission-error': '#ef4444',
                        'massdwell': '#112C48'
                    }
                }
            }
        }
    </script>
    <style>
        .scrollbar-thin {
            scrollbar-width: thin;
        }
        .scrollbar-track-transparent {
            scrollbar-color: #374151 transparent;
        }
        .drag-over {
            background-color: rgba(59, 130, 246, 0.1) !important;
            border-color: #3b82f6 !important;
        }
        .task-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        .pulse-dot {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .modal-backdrop {
            backdrop-filter: blur(4px);
        }
        .overdue-task {
            border: 2px solid #ef4444 !important;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.3);
        }
        .overdue-badge {
            background: #ef4444;
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            position: absolute;
            top: -8px;
            right: -8px;
        }
        .calendar-day {
            min-height: 80px;
            border: 1px solid #374151;
            padding: 4px;
        }
        .calendar-day:hover {
            background-color: rgba(59, 130, 246, 0.1);
        }
        .calendar-day.other-month {
            color: #6b7280;
            background-color: #1f2937;
        }
        .calendar-day.today {
            background-color: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
        }
        .calendar-task {
            font-size: 10px;
            padding: 2px 4px;
            margin: 1px 0;
            border-radius: 3px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 2px;
        }
        .calendar-task:hover {
            opacity: 0.8;
        }
        .calendar-task.priority-urgent { background: #ef4444; }
        .calendar-task.priority-high { background: #f59e0b; }
        .calendar-task.priority-medium { background: #3b82f6; }
        .calendar-task.priority-low { background: #6b7280; }
        .calendar-task.priority-recurring { background: #8b5cf6; }
    </style>
</head>
<body class="bg-mission-bg text-white font-sans">
    <!-- Header -->
    <header class="bg-mission-card border-b border-gray-700 px-6 py-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-6">
                    <h1 class="text-2xl font-bold text-mission-accent">üéõÔ∏è Mission Control v2</h1>
                    <div class="flex bg-gray-800 rounded-lg p-1">
                        <button id="boardViewBtn" class="px-4 py-2 rounded-md text-sm font-medium bg-mission-accent text-white">Board</button>
                        <button id="calendarViewBtn" class="px-4 py-2 rounded-md text-sm font-medium text-gray-400 hover:text-white">Calendar</button>
                    </div>
                </div>
                <div class="flex items-center space-x-2 text-sm text-gray-400">
                    <div id="statusIndicator" class="w-3 h-3 rounded-full bg-mission-success pulse-dot"></div>
                    <span id="statusText">Online</span>
                    <span>‚Ä¢</span>
                    <span id="lastUpdate">Updated now</span>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <button id="createTaskBtn" class="bg-mission-accent hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                    + New Task
                </button>
                <button id="refreshBtn" class="text-gray-400 hover:text-white transition-colors p-2 rounded-lg hover:bg-gray-700">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                </button>
                <div class="relative">
                    <button id="notificationBtn" class="text-gray-400 hover:text-white transition-colors p-2 rounded-lg hover:bg-gray-700 relative">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-2.405-2.405A8.055 8.055 0 0120 12c0-4.418-3.582-8-8-8s-8 3.582-8 8c0 1.962.712 3.758 1.905 5.195L4 17h5m6 0v1a3 3 0 01-6 0v-1m6 0H9"></path>
                        </svg>
                        <span id="notificationBadge" class="absolute -top-1 -right-1 bg-mission-error text-xs rounded-full px-1.5 py-0.5 text-white font-bold hidden">3</span>
                    </button>
                </div>
                <button id="settingsBtn" class="text-gray-400 hover:text-white transition-colors p-2 rounded-lg hover:bg-gray-700" title="Settings">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                </button>
                <span id="syncStatus" class="text-xs text-gray-500 hidden"></span>
            </div>
        </div>
    </header>

    <div class="flex h-screen overflow-hidden">
        <!-- Agent Status Panel (Left Sidebar) -->
        <div class="w-80 bg-mission-card border-r border-gray-700 p-6 overflow-y-auto scrollbar-thin scrollbar-track-transparent">
            <h2 class="text-lg font-semibold mb-6 text-gray-300">Agent Status</h2>
            <div id="agentList" class="space-y-4">
                <!-- Agents will be populated by JavaScript -->
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="flex-1 flex flex-col">
            <!-- Task Board (Kanban) -->
            <div id="boardView" class="flex-1 p-6 overflow-hidden">
                <h2 class="text-xl font-semibold mb-6 text-gray-300">Task Board</h2>
                <div class="grid grid-cols-4 gap-6 h-full">
                    <div class="bg-mission-card rounded-lg p-4 flex flex-col">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-gray-300">üì• Backlog</h3>
                            <span id="backlogCount" class="bg-gray-600 text-xs px-2 py-1 rounded-full">0</span>
                        </div>
                        <div id="backlogColumn" class="flex-1 space-y-3 overflow-y-auto scrollbar-thin scrollbar-track-transparent min-h-0" data-status="backlog">
                            <!-- Tasks will be populated here -->
                        </div>
                    </div>
                    <div class="bg-mission-card rounded-lg p-4 flex flex-col">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-gray-300">‚ñ∂Ô∏è In Progress</h3>
                            <span id="progressCount" class="bg-mission-accent text-xs px-2 py-1 rounded-full">0</span>
                        </div>
                        <div id="progressColumn" class="flex-1 space-y-3 overflow-y-auto scrollbar-thin scrollbar-track-transparent min-h-0" data-status="in_progress">
                            <!-- Tasks will be populated here -->
                        </div>
                    </div>
                    <div class="bg-mission-card rounded-lg p-4 flex flex-col">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-gray-300">üëÄ Review</h3>
                            <span id="reviewCount" class="bg-mission-warning text-xs px-2 py-1 rounded-full">0</span>
                        </div>
                        <div id="reviewColumn" class="flex-1 space-y-3 overflow-y-auto scrollbar-thin scrollbar-track-transparent min-h-0" data-status="review">
                            <!-- Tasks will be populated here -->
                        </div>
                    </div>
                    <div class="bg-mission-card rounded-lg p-4 flex flex-col">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-gray-300">‚úÖ Done</h3>
                            <span id="doneCount" class="bg-mission-success text-xs px-2 py-1 rounded-full">0</span>
                        </div>
                        <div id="doneColumn" class="flex-1 space-y-3 overflow-y-auto scrollbar-thin scrollbar-track-transparent min-h-0" data-status="done">
                            <!-- Tasks will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calendar View -->
            <div id="calendarView" class="flex-1 p-6 overflow-hidden hidden">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-semibold text-gray-300">Calendar</h2>
                    <div class="flex items-center space-x-4">
                        <button id="calendarPrevBtn" class="p-2 text-gray-400 hover:text-white rounded-lg hover:bg-gray-700">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                        </button>
                        <h3 id="calendarMonth" class="text-lg font-medium min-w-48 text-center"></h3>
                        <button id="calendarNextBtn" class="p-2 text-gray-400 hover:text-white rounded-lg hover:bg-gray-700">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="bg-mission-card rounded-lg p-4 h-full">
                    <div class="grid grid-cols-7 gap-1 mb-4">
                        <div class="text-center text-gray-400 text-sm font-medium p-2">Mon</div>
                        <div class="text-center text-gray-400 text-sm font-medium p-2">Tue</div>
                        <div class="text-center text-gray-400 text-sm font-medium p-2">Wed</div>
                        <div class="text-center text-gray-400 text-sm font-medium p-2">Thu</div>
                        <div class="text-center text-gray-400 text-sm font-medium p-2">Fri</div>
                        <div class="text-center text-gray-400 text-sm font-medium p-2">Sat</div>
                        <div class="text-center text-gray-400 text-sm font-medium p-2">Sun</div>
                    </div>
                    <div id="calendarGrid" class="grid grid-cols-7 gap-1 h-96 overflow-y-auto">
                        <!-- Calendar days will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Activity Feed (Bottom) -->
            <div class="bg-mission-card border-t border-gray-700 p-6 h-64">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-gray-300">Recent Activity</h2>
                    <select id="activityFilter" class="bg-gray-700 text-white px-3 py-1 rounded text-sm">
                        <option value="all">All Activity</option>
                        <option value="clawson">ü¶Ö Clawson</option>
                        <option value="marketing_content">üì£ Marketing</option>
                        <option value="sales_followup">üíº Sales</option>
                        <option value="admin_assistant">üîß Admin</option>
                    </select>
                </div>
                <div id="activityFeed" class="space-y-2 overflow-y-auto scrollbar-thin scrollbar-track-transparent h-40">
                    <!-- Activity items will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Create Task Modal -->
    <div id="createTaskModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-mission-card rounded-lg p-6 w-full max-w-md">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-semibold">Create New Task</h3>
                    <button id="closeCreateModal" class="text-gray-400 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <form id="createTaskForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Title *</label>
                        <input type="text" id="taskTitle" required class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-mission-accent focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Description</label>
                        <textarea id="taskDescription" rows="3" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-mission-accent focus:border-transparent"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Assignee</label>
                        <select id="taskAssignee" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-mission-accent focus:border-transparent">
                            <option value="clawson">ü¶Ö Clawson</option>
                            <option value="marketing_content">üì£ Marketing</option>
                            <option value="sales_followup">üíº Sales</option>
                            <option value="admin_assistant">üîß Admin</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Priority</label>
                        <select id="taskPriority" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-mission-accent focus:border-transparent">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                        <div id="dueDateDisplay" class="text-sm text-gray-400 mt-1"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Tags (comma separated)</label>
                        <input type="text" id="taskTags" placeholder="e.g. sales, urgent, automation" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-mission-accent focus:border-transparent">
                    </div>
                    <div class="flex space-x-3 pt-4">
                        <button type="submit" class="flex-1 bg-mission-accent hover:bg-blue-600 text-white py-2 px-4 rounded-lg font-medium transition-colors">
                            Create Task
                        </button>
                        <button type="button" id="cancelCreateTask" class="px-4 py-2 text-gray-400 hover:text-white transition-colors">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Task Details Modal -->
    <div id="taskDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-mission-card rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-6">
                    <h3 id="taskDetailsTitle" class="text-lg font-semibold">Task Details</h3>
                    <button id="closeDetailsModal" class="text-gray-400 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div id="taskDetailsContent" class="space-y-4">
                    <!-- Task details will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Agent Details Modal -->
    <div id="agentDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-mission-card rounded-lg p-6 w-full max-w-lg">
                <div class="flex items-center justify-between mb-6">
                    <h3 id="agentDetailsTitle" class="text-lg font-semibold">Agent Details</h3>
                    <button id="closeAgentModal" class="text-gray-400 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div id="agentDetailsContent">
                    <!-- Agent details will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-mission-card rounded-lg p-6 w-full max-w-lg">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-semibold">‚öôÔ∏è Settings</h3>
                    <button id="closeSettingsModal" class="text-gray-400 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">GitHub Personal Access Token</label>
                        <input type="password" id="githubToken" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white" placeholder="ghp_xxxxxxxxxxxx">
                        <p class="text-xs text-gray-500 mt-1">Required to save changes. Get one at GitHub ‚Üí Settings ‚Üí Developer settings ‚Üí Personal access tokens</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="autoSaveEnabled" class="rounded bg-gray-700 border-gray-600">
                        <label for="autoSaveEnabled" class="text-sm text-gray-300">Auto-save changes to GitHub</label>
                    </div>
                    <div id="settingsStatus" class="text-sm hidden"></div>
                    <div class="flex gap-2 pt-4">
                        <button id="saveSettingsBtn" class="flex-1 bg-mission-accent hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium">Save Settings</button>
                        <button id="testConnectionBtn" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-medium">Test</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let data = null;
        let draggedTask = null;
        let currentView = 'board';
        let currentCalendarDate = new Date();
        let githubToken = localStorage.getItem('mc_github_token') || '';
        let autoSaveEnabled = localStorage.getItem('mc_auto_save') === 'true';

        // Initialize the dashboard
        async function init() {
            try {
                await loadData();
                renderAgents();
                renderTasks();
                renderActivity();
                setupEventListeners();
                startPolling();
                updateLastRefresh();
                
                // Load saved view preference
                const savedView = localStorage.getItem('missionControlView') || 'board';
                switchView(savedView);
            } catch (error) {
                console.error('Failed to initialize dashboard:', error);
                updateStatus('offline', 'Error loading data');
            }
        }

        // Load data from JSON file
        async function loadData() {
            try {
                const response = await fetch('./data/data.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                data = await response.json();
                updateStatus('online', 'Online');
            } catch (error) {
                console.error('Error loading data:', error);
                updateStatus('offline', 'Offline');
                throw error;
            }
        }

        // Update status indicator
        function updateStatus(status, text) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            indicator.className = `w-3 h-3 rounded-full ${
                status === 'online' ? 'bg-mission-success pulse-dot' : 'bg-mission-error'
            }`;
            statusText.textContent = text;
        }

        // Update last refresh time
        function updateLastRefresh() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            });
            document.getElementById('lastUpdate').textContent = `Updated ${timeStr}`;
        }

        // Render agents in sidebar
        function renderAgents() {
            const agentList = document.getElementById('agentList');
            agentList.innerHTML = '';

            data.agents.forEach(agent => {
                const statusColor = getStatusColor(agent.status);
                const statusIcon = getStatusIcon(agent.status);
                const lastSeen = formatTime(agent.lastSeen);

                const agentDiv = document.createElement('div');
                agentDiv.className = 'bg-gray-800 rounded-lg p-4 cursor-pointer hover:bg-gray-700 transition-colors';
                agentDiv.onclick = () => showAgentDetails(agent);
                
                agentDiv.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl">${agent.emoji}</span>
                            <div>
                                <div class="font-medium">${agent.name}</div>
                                <div class="text-xs text-gray-400">${agent.role}</div>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center space-x-2">
                            <div class="w-2 h-2 rounded-full ${statusColor}"></div>
                            <span class="text-gray-400">${statusIcon}</span>
                        </div>
                        <span class="text-gray-500">${lastSeen}</span>
                    </div>
                    ${agent.currentTask ? `<div class="text-xs text-mission-accent mt-1">Working on ${agent.currentTask}</div>` : ''}
                `;

                agentList.appendChild(agentDiv);
            });
        }

        // Render tasks in Kanban columns
        function renderTasks() {
            const columns = {
                backlog: document.getElementById('backlogColumn'),
                in_progress: document.getElementById('progressColumn'),
                review: document.getElementById('reviewColumn'),
                done: document.getElementById('doneColumn')
            };

            // Clear all columns
            Object.values(columns).forEach(column => column.innerHTML = '');

            // Count tasks by status
            const counts = { backlog: 0, in_progress: 0, review: 0, done: 0 };
            const overdueCounts = { backlog: 0, in_progress: 0, review: 0, done: 0 };

            data.tasks.forEach(task => {
                if (columns[task.status]) {
                    const taskCard = createTaskCard(task);
                    columns[task.status].appendChild(taskCard);
                    counts[task.status]++;
                    if (isTaskOverdue(task)) {
                        overdueCounts[task.status]++;
                    }
                }
            });

            // Update count badges
            document.getElementById('backlogCount').textContent = counts.backlog + (overdueCounts.backlog > 0 ? ` (${overdueCounts.backlog} overdue)` : '');
            document.getElementById('progressCount').textContent = counts.in_progress + (overdueCounts.in_progress > 0 ? ` (${overdueCounts.in_progress} overdue)` : '');
            document.getElementById('reviewCount').textContent = counts.review + (overdueCounts.review > 0 ? ` (${overdueCounts.review} overdue)` : '');
            document.getElementById('doneCount').textContent = counts.done;
        }

        // Create a task card element
        function createTaskCard(task) {
            const card = document.createElement('div');
            card.className = 'bg-gray-800 rounded-lg p-3 cursor-pointer task-card relative';
            card.draggable = true;
            card.dataset.taskId = task.id;
            
            const priorityColor = getPriorityColor(task.priority);
            const project = data.projects?.find(p => p.id === task.project);
            const assigneeAgent = data.agents.find(a => a.id === task.assignee);
            const isOverdue = isTaskOverdue(task);
            
            card.innerHTML = `
                ${isOverdue ? '<div class="overdue-badge">OVERDUE</div>' : ''}
                <div class="flex items-start justify-between mb-2">
                    <div class="flex items-center space-x-2">
                        <div class="w-2 h-2 rounded-full ${priorityColor}"></div>
                        <span class="text-xs font-medium text-gray-400">${task.id}</span>
                    </div>
                    ${assigneeAgent ? `<span class="text-sm">${assigneeAgent.emoji}</span>` : ''}
                </div>
                <div class="font-medium text-sm mb-2 line-clamp-2">${task.title}</div>
                <div class="flex items-center justify-between text-xs">
                    <div class="flex items-center space-x-2">
                        ${project ? `<span class="bg-gray-700 px-2 py-1 rounded text-xs" style="color: ${project.color}">${project.emoji} ${project.name}</span>` : ''}
                    </div>
                    ${task.dueDate ? `<div class="text-gray-500 text-xs">Due: ${formatDueDate(task.dueDate)}</div>` : ''}
                </div>
                ${task.tags && task.tags.length > 0 ? `
                    <div class="flex flex-wrap gap-1 mt-2">
                        ${task.tags.slice(0, 2).map(tag => `<span class="bg-gray-700 px-2 py-0.5 rounded-full text-xs text-gray-300">${tag}</span>`).join('')}
                        ${task.tags.length > 2 ? `<span class="text-xs text-gray-500">+${task.tags.length - 2}</span>` : ''}
                    </div>
                ` : ''}
            `;

            // Add overdue styling
            if (isOverdue) {
                card.classList.add('overdue-task');
            }

            // Add event listeners
            card.addEventListener('click', () => showTaskDetails(task));
            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragend', handleDragEnd);

            return card;
        }

        // Render activity feed
        function renderActivity() {
            const activityFeed = document.getElementById('activityFeed');
            const filter = document.getElementById('activityFilter').value;
            
            activityFeed.innerHTML = '';

            const filteredActivity = data.activity.filter(item => 
                filter === 'all' || item.agent === filter
            );

            filteredActivity.slice(0, 20).forEach(item => {
                const timeStr = formatTime(item.timestamp);
                const activityDiv = document.createElement('div');
                activityDiv.className = 'flex items-center space-x-3 text-sm py-2 border-b border-gray-700 last:border-b-0';
                
                activityDiv.innerHTML = `
                    <span class="text-gray-500 font-mono text-xs w-12">${timeStr}</span>
                    <span class="text-lg">${item.agentEmoji}</span>
                    <span class="flex-1">${item.message}</span>
                `;

                activityFeed.appendChild(activityDiv);
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // View toggle
            document.getElementById('boardViewBtn').addEventListener('click', () => switchView('board'));
            document.getElementById('calendarViewBtn').addEventListener('click', () => switchView('calendar'));

            // Calendar navigation
            document.getElementById('calendarPrevBtn').addEventListener('click', () => navigateCalendar(-1));
            document.getElementById('calendarNextBtn').addEventListener('click', () => navigateCalendar(1));

            // Create task modal
            document.getElementById('createTaskBtn').addEventListener('click', () => {
                document.getElementById('createTaskModal').classList.remove('hidden');
                updateDueDateDisplay();
            });

            document.getElementById('closeCreateModal').addEventListener('click', closeCreateModal);
            document.getElementById('cancelCreateTask').addEventListener('click', closeCreateModal);
            
            // Update due date when priority changes
            document.getElementById('taskPriority').addEventListener('change', updateDueDateDisplay);
            
            document.getElementById('createTaskForm').addEventListener('submit', handleCreateTask);

            // Task details modal
            document.getElementById('closeDetailsModal').addEventListener('click', () => {
                document.getElementById('taskDetailsModal').classList.add('hidden');
            });

            // Agent details modal
            document.getElementById('closeAgentModal').addEventListener('click', () => {
                document.getElementById('agentDetailsModal').classList.add('hidden');
            });

            // Refresh button
            document.getElementById('refreshBtn').addEventListener('click', async () => {
                document.getElementById('refreshBtn').style.animation = 'spin 1s linear';
                await loadData();
                renderAgents();
                renderTasks();
                renderActivity();
                updateLastRefresh();
                setTimeout(() => {
                    document.getElementById('refreshBtn').style.animation = '';
                }, 1000);
            });

            // Activity filter
            document.getElementById('activityFilter').addEventListener('change', renderActivity);

            // Setup drag and drop for columns
            document.querySelectorAll('[data-status]').forEach(column => {
                column.addEventListener('dragover', handleDragOver);
                column.addEventListener('drop', handleDrop);
                column.addEventListener('dragenter', handleDragEnter);
                column.addEventListener('dragleave', handleDragLeave);
            });

            // Settings modal
            document.getElementById('settingsBtn').addEventListener('click', () => {
                document.getElementById('githubToken').value = githubToken;
                document.getElementById('autoSaveEnabled').checked = autoSaveEnabled;
                document.getElementById('settingsModal').classList.remove('hidden');
            });
            document.getElementById('closeSettingsModal').addEventListener('click', () => {
                document.getElementById('settingsModal').classList.add('hidden');
            });
            document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
            document.getElementById('testConnectionBtn').addEventListener('click', testGitHubConnection);
        }

        // Save settings
        function saveSettings() {
            githubToken = document.getElementById('githubToken').value;
            autoSaveEnabled = document.getElementById('autoSaveEnabled').checked;
            localStorage.setItem('mc_github_token', githubToken);
            localStorage.setItem('mc_auto_save', autoSaveEnabled.toString());
            showSettingsStatus('‚úÖ Settings saved!', 'text-green-400');
            setTimeout(() => document.getElementById('settingsModal').classList.add('hidden'), 1000);
        }

        // Show settings status
        function showSettingsStatus(message, colorClass) {
            const status = document.getElementById('settingsStatus');
            status.textContent = message;
            status.className = `text-sm ${colorClass}`;
            status.classList.remove('hidden');
        }

        // Test GitHub connection
        async function testGitHubConnection() {
            const token = document.getElementById('githubToken').value;
            if (!token) {
                showSettingsStatus('‚ùå Enter a token first', 'text-red-400');
                return;
            }
            try {
                const response = await fetch('https://api.github.com/repos/MassDwell/mission-control', {
                    headers: { 'Authorization': `token ${token}` }
                });
                if (response.ok) {
                    showSettingsStatus('‚úÖ Connection successful!', 'text-green-400');
                } else {
                    showSettingsStatus('‚ùå Invalid token or no access', 'text-red-400');
                }
            } catch (error) {
                showSettingsStatus('‚ùå Connection failed', 'text-red-400');
            }
        }

        // Save to GitHub
        async function saveToGitHub() {
            if (!githubToken || !autoSaveEnabled) return;
            
            const syncStatus = document.getElementById('syncStatus');
            syncStatus.textContent = 'üíæ Saving...';
            syncStatus.classList.remove('hidden');
            
            try {
                // Get current file SHA
                const getResponse = await fetch('https://api.github.com/repos/MassDwell/mission-control/contents/data/data.json', {
                    headers: { 'Authorization': `token ${githubToken}` }
                });
                const fileData = await getResponse.json();
                const sha = fileData.sha;
                
                // Update file
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
                const updateResponse = await fetch('https://api.github.com/repos/MassDwell/mission-control/contents/data/data.json', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Dashboard update: ${new Date().toISOString()}`,
                        content: content,
                        sha: sha
                    })
                });
                
                if (updateResponse.ok) {
                    syncStatus.textContent = '‚úÖ Saved';
                    setTimeout(() => syncStatus.classList.add('hidden'), 2000);
                } else {
                    throw new Error('Save failed');
                }
            } catch (error) {
                console.error('GitHub save error:', error);
                syncStatus.textContent = '‚ùå Save failed';
                syncStatus.className = 'text-xs text-red-400';
                setTimeout(() => syncStatus.classList.add('hidden'), 3000);
            }
        }

        // Handle task creation
        function handleCreateTask(e) {
            e.preventDefault();
            
            const title = document.getElementById('taskTitle').value;
            const description = document.getElementById('taskDescription').value;
            const assignee = document.getElementById('taskAssignee').value;
            const priority = document.getElementById('taskPriority').value;
            const tags = document.getElementById('taskTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);

            const newTask = {
                id: `MC-${String(Date.now()).slice(-3)}`,
                title,
                description,
                status: 'backlog',
                project: 'infrastructure',
                assignee,
                tags,
                priority,
                createdAt: new Date().toISOString(),
                dueDate: calculateDueDate(priority)
            };

            data.tasks.push(newTask);
            renderTasks();
            closeCreateModal();

            // Add activity
            const agent = data.agents.find(a => a.id === assignee);
            data.activity.unshift({
                id: `act_${Date.now()}`,
                type: 'task_created',
                agent: 'system',
                agentEmoji: '‚öôÔ∏è',
                message: `Created task "${title}" assigned to ${agent?.name || assignee}`,
                taskId: newTask.id,
                timestamp: new Date().toISOString()
            });
            renderActivity();
            
            // Save to GitHub
            saveToGitHub();
        }

        // Close create modal
        function closeCreateModal() {
            document.getElementById('createTaskModal').classList.add('hidden');
            document.getElementById('createTaskForm').reset();
        }

        // Show task details
        function showTaskDetails(task) {
            const modal = document.getElementById('taskDetailsModal');
            const title = document.getElementById('taskDetailsTitle');
            const content = document.getElementById('taskDetailsContent');

            title.textContent = task.title;

            const project = data.projects?.find(p => p.id === task.project);
            const assigneeAgent = data.agents.find(a => a.id === task.assignee);
            const priorityColor = getPriorityColor(task.priority);

            content.innerHTML = `
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="text-sm text-gray-400">ID</label>
                        <div class="font-mono">${task.id}</div>
                    </div>
                    <div>
                        <label class="text-sm text-gray-400">Status</label>
                        <div class="capitalize">${task.status.replace('_', ' ')}</div>
                    </div>
                    <div>
                        <label class="text-sm text-gray-400">Priority</label>
                        <div class="flex items-center space-x-2">
                            <div class="w-2 h-2 rounded-full ${priorityColor}"></div>
                            <span class="capitalize">${task.priority}</span>
                        </div>
                    </div>
                    <div>
                        <label class="text-sm text-gray-400">Assignee</label>
                        <div>${assigneeAgent ? `${assigneeAgent.emoji} ${assigneeAgent.name}` : task.assignee}</div>
                    </div>
                    ${project ? `
                        <div>
                            <label class="text-sm text-gray-400">Project</label>
                            <div>${project.emoji} ${project.name}</div>
                        </div>
                    ` : ''}
                    <div>
                        <label class="text-sm text-gray-400">Created</label>
                        <div>${formatDateTime(task.createdAt)}</div>
                    </div>
                    ${task.dueDate ? `
                        <div>
                            <label class="text-sm text-gray-400">Due Date</label>
                            <div class="${isTaskOverdue(task) ? 'text-mission-error font-bold' : ''}">${formatDateTime(task.dueDate)}</div>
                        </div>
                    ` : ''}
                </div>
                ${task.description ? `
                    <div class="mb-4">
                        <label class="text-sm text-gray-400">Description</label>
                        <div class="mt-1 p-3 bg-gray-800 rounded text-sm whitespace-pre-wrap">${task.description}</div>
                    </div>
                ` : ''}
                ${task.tags && task.tags.length > 0 ? `
                    <div class="mb-4">
                        <label class="text-sm text-gray-400">Tags</label>
                        <div class="flex flex-wrap gap-2 mt-1">
                            ${task.tags.map(tag => `<span class="bg-gray-700 px-2 py-1 rounded text-sm">${tag}</span>`).join('')}
                        </div>
                    </div>
                ` : ''}
                ${task.recurring && task.recurring.enabled ? `
                    <div class="mb-4">
                        <label class="text-sm text-gray-400">Recurring Schedule</label>
                        <div class="mt-1 p-3 bg-gray-800 rounded text-sm">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-purple-400">üîÑ</span>
                                <span class="font-medium">Recurring Task</span>
                            </div>
                            <div>Frequency: ${task.recurring.frequency}</div>
                            ${task.recurring.days ? `<div>Days: ${task.recurring.days.map(d => ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'][d-1]).join(', ')}</div>` : ''}
                        </div>
                    </div>
                ` : ''}
            `;

            modal.classList.remove('hidden');
        }

        // Show agent details
        function showAgentDetails(agent) {
            const modal = document.getElementById('agentDetailsModal');
            const title = document.getElementById('agentDetailsTitle');
            const content = document.getElementById('agentDetailsContent');

            title.textContent = `${agent.emoji} ${agent.name}`;

            const statusColor = getStatusColor(agent.status);
            const statusIcon = getStatusIcon(agent.status);
            const assignedTasks = data.tasks.filter(task => task.assignee === agent.id);
            const completedTasks = assignedTasks.filter(task => task.status === 'done');

            content.innerHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm text-gray-400">Role</label>
                            <div>${agent.role}</div>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400">Level</label>
                            <div class="capitalize">${agent.level}</div>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400">Status</label>
                            <div class="flex items-center space-x-2">
                                <div class="w-2 h-2 rounded-full ${statusColor}"></div>
                                <span>${statusIcon}</span>
                            </div>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400">Last Seen</label>
                            <div>${formatDateTime(agent.lastSeen)}</div>
                        </div>
                    </div>
                    
                    ${agent.currentTask ? `
                        <div>
                            <label class="text-sm text-gray-400">Current Task</label>
                            <div class="text-mission-accent">${agent.currentTask}</div>
                        </div>
                    ` : ''}

                    <div>
                        <label class="text-sm text-gray-400">Statistics</label>
                        <div class="grid grid-cols-2 gap-4 mt-2">
                            <div class="bg-gray-800 rounded p-3 text-center">
                                <div class="text-2xl font-bold text-mission-accent">${assignedTasks.length}</div>
                                <div class="text-sm text-gray-400">Assigned Tasks</div>
                            </div>
                            <div class="bg-gray-800 rounded p-3 text-center">
                                <div class="text-2xl font-bold text-mission-success">${completedTasks.length}</div>
                                <div class="text-sm text-gray-400">Completed</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            modal.classList.remove('hidden');
        }

        // Drag and drop handlers
        function handleDragStart(e) {
            draggedTask = e.target.dataset.taskId;
            e.target.style.opacity = '0.5';
        }

        function handleDragEnd(e) {
            e.target.style.opacity = '';
            draggedTask = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleDragEnter(e) {
            e.preventDefault();
            e.target.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.target.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.target.classList.remove('drag-over');
            
            if (!draggedTask) return;

            const newStatus = e.target.dataset.status;
            if (!newStatus) return;

            // Find and update the task
            const task = data.tasks.find(t => t.id === draggedTask);
            if (!task || task.status === newStatus) return;

            const oldStatus = task.status;
            task.status = newStatus;

            // Add activity
            const agent = data.agents.find(a => a.id === task.assignee);
            data.activity.unshift({
                id: `act_${Date.now()}`,
                type: 'task_moved',
                agent: 'system',
                agentEmoji: '‚öôÔ∏è',
                message: `Moved "${task.title}" from ${oldStatus.replace('_', ' ')} to ${newStatus.replace('_', ' ')}`,
                taskId: task.id,
                timestamp: new Date().toISOString()
            });

            renderTasks();
            renderActivity();
            
            // Save to GitHub
            saveToGitHub();
        }

        // Utility functions
        function getStatusColor(status) {
            switch (status) {
                case 'working': return 'bg-mission-success';
                case 'idle': return 'bg-mission-warning';
                case 'offline': return 'bg-mission-error';
                case 'paused': return 'bg-gray-500';
                default: return 'bg-gray-500';
            }
        }

        function getStatusIcon(status) {
            switch (status) {
                case 'working': return 'üü¢ Working';
                case 'idle': return 'üí§ Idle';
                case 'offline': return 'üî¥ Offline';
                case 'paused': return '‚è∏Ô∏è Paused';
                default: return '‚ùì Unknown';
            }
        }

        function getPriorityColor(priority) {
            switch (priority) {
                case 'urgent': return 'bg-mission-error';
                case 'high': return 'bg-mission-warning';
                case 'medium': return 'bg-mission-accent';
                case 'low': return 'bg-gray-500';
                default: return 'bg-gray-500';
            }
        }

        function formatTime(timestamp) {
            const now = new Date();
            const time = new Date(timestamp);
            const diffMs = now - time;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);

            if (diffMins < 1) return 'now';
            if (diffMins < 60) return `${diffMins}m`;
            if (diffHours < 24) return `${diffHours}h`;
            return `${diffDays}d`;
        }

        function formatDateTime(timestamp) {
            return new Date(timestamp).toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
        }

        // New utility functions
        function calculateDueDate(priority) {
            const now = new Date();
            const daysToAdd = {
                'urgent': 0,    // Due immediately (same day)
                'high': 1,      // Due in 1 day
                'medium': 3,    // Due in 3 days
                'low': 7        // Due in 7 days
            };
            
            const days = daysToAdd[priority] || 3;
            const dueDate = new Date(now);
            dueDate.setDate(dueDate.getDate() + days);
            return dueDate.toISOString();
        }

        function updateDueDateDisplay() {
            const priority = document.getElementById('taskPriority').value;
            const dueDate = new Date(calculateDueDate(priority));
            const display = document.getElementById('dueDateDisplay');
            display.textContent = `Due: ${dueDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
        }

        function formatDueDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function isTaskOverdue(task) {
            if (!task.dueDate || task.status === 'done') return false;
            return new Date(task.dueDate) < new Date();
        }

        function switchView(view) {
            currentView = view;
            localStorage.setItem('missionControlView', view);
            
            if (view === 'board') {
                document.getElementById('boardView').classList.remove('hidden');
                document.getElementById('calendarView').classList.add('hidden');
                document.getElementById('boardViewBtn').classList.add('bg-mission-accent', 'text-white');
                document.getElementById('boardViewBtn').classList.remove('text-gray-400');
                document.getElementById('calendarViewBtn').classList.remove('bg-mission-accent', 'text-white');
                document.getElementById('calendarViewBtn').classList.add('text-gray-400');
            } else if (view === 'calendar') {
                document.getElementById('boardView').classList.add('hidden');
                document.getElementById('calendarView').classList.remove('hidden');
                document.getElementById('calendarViewBtn').classList.add('bg-mission-accent', 'text-white');
                document.getElementById('calendarViewBtn').classList.remove('text-gray-400');
                document.getElementById('boardViewBtn').classList.remove('bg-mission-accent', 'text-white');
                document.getElementById('boardViewBtn').classList.add('text-gray-400');
                renderCalendar();
            }
        }

        function navigateCalendar(direction) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
            renderCalendar();
        }

        function renderCalendar() {
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];
            
            document.getElementById('calendarMonth').textContent = 
                `${monthNames[currentCalendarDate.getMonth()]} ${currentCalendarDate.getFullYear()}`;

            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';

            const firstDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1);
            const lastDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 0);
            
            // Start from Monday
            const startDate = new Date(firstDay);
            const dayOfWeek = firstDay.getDay();
            startDate.setDate(startDate.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for (let i = 0; i < 42; i++) { // 6 weeks * 7 days
                const cellDate = new Date(startDate);
                cellDate.setDate(startDate.getDate() + i);
                
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                
                const isCurrentMonth = cellDate.getMonth() === currentCalendarDate.getMonth();
                const isToday = cellDate.getTime() === today.getTime();
                
                if (!isCurrentMonth) {
                    dayCell.classList.add('other-month');
                }
                if (isToday) {
                    dayCell.classList.add('today');
                }

                // Date number
                const dateDiv = document.createElement('div');
                dateDiv.className = 'font-medium text-xs mb-1';
                dateDiv.textContent = cellDate.getDate();
                dayCell.appendChild(dateDiv);

                // Tasks for this day
                const tasksForDay = getTasksForDate(cellDate);
                tasksForDay.forEach(task => {
                    const taskElement = createCalendarTask(task);
                    dayCell.appendChild(taskElement);
                });

                dayCell.addEventListener('click', () => showDayTasks(cellDate, tasksForDay));
                grid.appendChild(dayCell);
            }
        }

        function getTasksForDate(date) {
            const tasks = [];
            const dateStr = date.toISOString().split('T')[0];
            
            data.tasks.forEach(task => {
                // Regular tasks with due dates
                if (task.dueDate && task.dueDate.split('T')[0] === dateStr) {
                    tasks.push({ ...task, isRecurring: false });
                }
                
                // Recurring tasks
                if (task.recurring && task.recurring.enabled) {
                    const dayOfWeek = date.getDay();
                    const adjustedDay = dayOfWeek === 0 ? 7 : dayOfWeek; // Convert Sunday from 0 to 7
                    
                    if (task.recurring.frequency === 'daily' && task.recurring.days.includes(adjustedDay)) {
                        tasks.push({ ...task, isRecurring: true });
                    }
                }
            });
            
            return tasks;
        }

        function createCalendarTask(task) {
            const taskDiv = document.createElement('div');
            const priorityClass = task.isRecurring ? 'priority-recurring' : `priority-${task.priority}`;
            taskDiv.className = `calendar-task ${priorityClass}`;
            
            const assigneeAgent = data.agents.find(a => a.id === task.assignee);
            const emoji = assigneeAgent ? assigneeAgent.emoji : 'üë§';
            
            // Truncate title if too long
            const title = task.title.length > 15 ? task.title.substring(0, 15) + '...' : task.title;
            
            taskDiv.innerHTML = `<span>${emoji}</span><span>${title}</span>`;
            taskDiv.onclick = (e) => {
                e.stopPropagation();
                showTaskDetails(task);
            };
            
            return taskDiv;
        }

        function showDayTasks(date, tasks) {
            const dateStr = date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            alert(`Tasks for ${dateStr}:\n\n${tasks.map(t => `‚Ä¢ ${t.title}`).join('\n') || 'No tasks for this day'}`);
        }

        // Polling function
        function startPolling() {
            // Refresh every 30 seconds
            setInterval(async () => {
                try {
                    await loadData();
                    renderAgents();
                    renderTasks();
                    renderActivity();
                    updateLastRefresh();
                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, 30000);
        }

        // Add CSS animation for refresh button
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>